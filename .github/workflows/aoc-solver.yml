name: AoC Solver

on:
  schedule:
    # Run at 12:01 AM EST daily in December (5:01 AM UTC)
    - cron: '1 5 * 12 *'

  workflow_dispatch:
    inputs:
      day:
        description: 'Day to solve (1-25)'
        required: true
        type: number
      year:
        description: 'Year'
        required: true
        type: number
        default: 2025

run-name: 'AoC ${{ inputs.year || ''2025'' }} Day ${{ inputs.day || github.run_number }}'

permissions:
  contents: write

jobs:
  solve:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine day and year
        id: set_day
        run: |
          if [ -n "${{ inputs.day }}" ]; then
            DAY="${{ inputs.day }}"
            YEAR="${{ inputs.year }}"
          else
            DAY=$(date +%-d)
            YEAR=$(date +%Y)
          fi
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "ðŸŽ„ Solving AoC $YEAR Day $DAY"

      - name: Fetch puzzle and setup
        env:
          AOC_SESSION: ${{ secrets.AOC_SESSION_COOKIE }}
          FORCE_DAY: ${{ steps.set_day.outputs.day }}
          FORCE_YEAR: ${{ steps.set_day.outputs.year }}
        run: python aoc-automation/solve_daily.py

      - name: Solve with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Solve Advent of Code ${{ steps.set_day.outputs.year }} Day ${{ steps.set_day.outputs.day }}.

            **Files:**
            - Puzzle description: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/puzzle.md`
            - Your input data: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/input.txt`
            - Solution file: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/day${{ steps.set_day.outputs.day }}.py`

            **Workflow:**
            1. Read `CLAUDE.md` for coding guidelines
            2. Read the puzzle description to understand Part 1
            3. Implement part1() function in the solution file
            4. Test your solution locally first
            5. Submit your answer:
               ```bash
               export AOC_SESSION=${{ secrets.AOC_SESSION_COOKIE }}
               export YEAR=${{ steps.set_day.outputs.year }}
               export DAY=${{ steps.set_day.outputs.day }}
               python aoc-automation/submit_answer.py 1 <your_answer> $DAY $YEAR
               ```
            6. The script will output the response from AoC - READ IT to see if correct
            7. If wrong, analyze the feedback and retry (you can submit multiple times)
            8. Once Part 1 is CORRECT: **commit the solution to main branch**
            9. Re-fetch the puzzle to get Part 2: `python aoc-automation/solve_daily.py`
            10. Implement part2() function
            11. Submit Part 2 the same way
            12. Once Part 2 is CORRECT: **commit again**

            **Important:**
            - The puzzle might already show Part 2 if Part 1 was previously solved
            - Determine which part(s) need solving by reading puzzle.md
            - Always test with the example data from puzzle.md before submitting
            - Commit after EACH part is solved (Part 1, then Part 2)
            - Follow the patterns in CLAUDE.md
          claude_args: "--allowedTools Read,Write,Edit,Bash,Glob,Grep --max-turns 50"
