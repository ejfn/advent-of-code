name: AoC Solver

on:
  schedule:
    # Run at 12:01 AM EST daily in December (5:01 AM UTC)
    - cron: '1 5 * 12 *'

  workflow_dispatch:
    inputs:
      day:
        description: 'Day to solve (1-25)'
        required: true
        type: number
      year:
        description: 'Year'
        required: true
        type: number
        default: 2025

run-name: 'AoC ${{ inputs.year || ''2025'' }} Day ${{ inputs.day || github.run_number }}'

permissions:
  contents: write

jobs:
  solve:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine day and year
        id: set_day
        run: |
          if [ -n "${{ inputs.day }}" ]; then
            DAY="${{ inputs.day }}"
            YEAR="${{ inputs.year }}"
          else
            DAY=$(date +%-d)
            YEAR=$(date +%Y)
          fi
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "üéÑ Solving AoC $YEAR Day $DAY"

      - name: Fetch puzzle and setup
        env:
          AOC_SESSION: ${{ secrets.AOC_SESSION_COOKIE }}
          FORCE_DAY: ${{ steps.set_day.outputs.day }}
          FORCE_YEAR: ${{ steps.set_day.outputs.year }}
        run: python aoc-automation/solve_daily.py

      - name: Solve with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Solve Advent of Code ${{ steps.set_day.outputs.year }} Day ${{ steps.set_day.outputs.day }}.

            YEAR=${{ steps.set_day.outputs.year }}
            DAY=${{ steps.set_day.outputs.day }}
            AOC_SESSION=${{ secrets.AOC_SESSION_COOKIE }}

            **EXACT filenames (DO NOT CHANGE):**
            - Puzzle: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/puzzle.md`
            - Input: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/input.txt`
            - Solution: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/day${{ steps.set_day.outputs.day }}.py` ‚Üê MUST use this exact name!

            **Steps:**
            1. Read CLAUDE.md for guidelines
            2. Read puzzle.md - determine if Part 1 and/or Part 2 need solving
            3. Write solution to day${{ steps.set_day.outputs.day }}.py (NOT test_day*.py!)
            4. Test it: `cd ${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }} && python day${{ steps.set_day.outputs.day }}.py`
            5. Submit answer: `python aoc-automation/submit_answer.py <part> <answer> $DAY $YEAR`
            6. READ the response - it will show if correct/wrong
            7. If wrong: fix and retry step 5
            8. If correct: IMMEDIATELY run `git add . && git commit -m "solve: day $DAY part X" && git push`
            9. Repeat for Part 2 if needed (re-fetch puzzle first with solve_daily.py)

            **CRITICAL:**
            - Use EXACT filename: day${{ steps.set_day.outputs.day }}.py (not test_*.py!)
            - Push after EVERY correct answer
            - Read CLAUDE.md for code structure
          claude_args: "--allowedTools Read,Write,Edit,Bash,Glob,Grep --max-turns 50"
