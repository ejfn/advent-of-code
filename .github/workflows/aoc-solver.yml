name: AoC Solver

on:
  schedule:
    # Run at 12:00 AM EST daily in December (5:00 AM UTC)
    - cron: "0 5 * 12 *"

  workflow_dispatch:
    inputs:
      year:
        description: "Year"
        required: true
        type: number
        default: 2025
      day:
        description: "Day to solve (1-25)"
        required: true
        type: number

run-name: "AoC ${{ inputs.year || '2025' }} ${{ inputs.day && format('Day {0}', inputs.day) || 'Daily Run' }}"

permissions:
  contents: write

jobs:
  solve:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine day and year
        id: set_day
        run: |
          if [ -n "${{ inputs.day }}" ]; then
            DAY="${{ inputs.day }}"
            YEAR="${{ inputs.year }}"
          else
            DAY=$(date +%-d)
            YEAR=$(date +%Y)
          fi

          # AoC only has 25 days, exit if day > 25
          if [ "$DAY" -gt 25 ]; then
            echo "Day $DAY is beyond AoC range (1-25), exiting"
            exit 0
          fi

          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "üéÑ Solving AoC $YEAR Day $DAY"

      - name: Solve with Claude
        id: claude
        env:
          AOC_SESSION: ${{ secrets.AOC_SESSION_COOKIE }}
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Solve Advent of Code ${{ steps.set_day.outputs.year }} Day ${{ steps.set_day.outputs.day }}.

            YEAR=${{ steps.set_day.outputs.year }}
            DAY=${{ steps.set_day.outputs.day }}
            AOC_SESSION=${{ secrets.AOC_SESSION_COOKIE }}

            **EXACT filenames (DO NOT CHANGE):**
            - Puzzle: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/puzzle.md`
            - Input: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/input.txt`
            - Solution: `${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/day${{ steps.set_day.outputs.day }}.py` ‚Üê MUST use this exact name!

            **Steps:**
            1. Fetch puzzle: `FORCE_DAY=$DAY FORCE_YEAR=$YEAR python aoc-automation/solve_daily.py`
            2. Read CLAUDE.md for guidelines
            3. Read puzzle.md and check if parts are already solved
               - If puzzle.md shows "Your puzzle answer was..." for BOTH parts: YOU'RE DONE! Exit immediately.
               - If only Part 1 is solved: Skip to step 8 (Part 2)
               - If neither solved: Continue to step 4
            4. Write solution to day${{ steps.set_day.outputs.day }}.py (NOT test_day*.py!)
            5. Test it with 120s timeout: `timeout 120 python ${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/day${{ steps.set_day.outputs.day }}.py`
            6. Submit answer: `python aoc-automation/submit_answer.py <part> <answer> $DAY $YEAR`
            7. READ the response - if wrong fix & retry, if correct:
               - Git add all files in folder: `git add ${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/`
               - Commit and push, then continue
            8. Re-fetch puzzle for Part 2: `FORCE_DAY=$DAY FORCE_YEAR=$YEAR python aoc-automation/solve_daily.py`
            9. Implement part2() in same file, test, submit:
               - Git add all files in folder: `git add ${{ steps.set_day.outputs.year }}/${{ steps.set_day.outputs.day }}/`
               - Commit and push

            **CRITICAL:**
            - If BOTH parts already solved: DO NOTHING and exit
            - Use EXACT filename: day${{ steps.set_day.outputs.day }}.py (not test_*.py!)
            - ALWAYS git add the entire day folder to commit all files (dayN.py, input.txt, etc.)
            - If you install new packages with pip: update requirements.txt and git add it too
            - Git push after EVERY correct answer
          claude_args: "--allowedTools Read,Write,Edit,Bash,Glob,Grep --max-turns 50"
